# 常见架构

## 典型的信息流架构

![image](https://ipad-cms.csdn.net/cms/attachment/201606/574d3722692bd.png)
![image](https://img-blog.csdn.net/20180330155606305?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Rlbmd4aW5nMTIzNA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

- [信息流推荐算法实践&深入](https://blog.csdn.net/dengxing1234/article/details/79756265)
- [推荐系统架构](https://www.cnblogs.com/redbear/p/8594939.html)


## Netflix个性化推荐架构

- 推荐系统特质
    - 实时响应请求
    - 及时、准确、全面记录用户反馈
    - 可以优雅降级
    - 快速实验多种策略
- Netflix的推荐系统架构图
![Netflix的推荐系统架构图](https://static001.geekbang.org/resource/image/a8/b4/a81afe3013542c6b22617ea56c025bb4.png)
- 每层架构说明：
![image](https://static001.geekbang.org/resource/image/5a/20/5aa4a361a2f0c480a15608e205553120.png)

## 推荐、搜索和广告的关系

- 过滤候选
    - 搜索：解析查询关键字以及结构化的搜索条件，从倒排索引中检索出候选
    - 推荐：召回阶段就是过滤候选
    - 广告：同搜索，通过关键字检索广告
- 排序候选
    - 搜索：排序目标是高相关性
    - 推荐：用CTR预估来融合召回策略中的候选集，再附加一定的约束（去重，多样性等）
    - 广告：结合CTR预估，出价、广告质量一起考虑
- 个性化输出
    - 推荐：只是推荐系统的衡量指标之一


# 关键模块

## 数据采集关键要素

- 数据采集主要用途：
    - 报表统计：核心产品指标，如留存，使用时长等
    - 数据分析：产出比较清晰直观的结论，用于指导产品设计、商业推广、开发方式
    - 机器学习：训练模型
- 日志的数据模型
    - 人、属性矩阵（User Profile）
    - 物、属性矩阵（Item Profile）
    - 人、人矩阵（Relation）：关系数据，并非所有产品都有
    - 人、物矩阵（Event）：事件数据，用户发生的行为和动作
- 收集哪些日志
    - 业务运转必须要存储的记录，如用户注册资料，通常是结构化存储
    - 用户使用产品时顺便记录下来，叫做埋点
        - SDK埋点，可视化埋点，无埋点
        - 前端埋点，后端埋点
- 用什么工具收集
    - 网络服务器日志，用Logstash手机
    - 业务服务器，通常分布在多台机器上，用Flume汇总
    - 发送到Kafka中指定的Topic中
    - 通过流计算框架Storm，实时处理采集到的数据，写入HDFS

## 实时推荐

- 实时推荐的三个层次：
    - “给的及时”，即服务的实时响应
    - “用的及时”，即特征的实时更新，例如用户刚购买一个商品，需立即加入历史行为中，参与下一次协同过滤的召回过程，这一操作仅影响当前用户
    - “改的及时”，即模型的实时更新，例如用户刚购买一个商品，需更新该商品与其他商品的相似度，这一操作影响全局推荐
- 用户行为数据经过实时的消息队列发布，然后由一个流计算平台消费这些实时数据，一方面直接清洗入库，另一方面参与实时推荐，并将实时计算的结果更新到推荐数据库，供实时服务使用
- 实时数据
    - 采用Kafka
- 实时数据计算（流计算）
    - 采用Storm，S4，Spark Streaming，Flink
- 算法实时化：例如基于物品的协同过滤，参考文章案例
- 效率提升
    - 剪枝：根据Hoeffding不等式计算，满足一定置信度和给定误差的条件下，需要最少的更新次数
    - 加窗：仅使用窗口内的历史行为数据参与实时计算
    - 采样：针对热门物品和活跃用户
    - 缓存：对高频访问的物品和用户进行缓存

## ABTest

- [Overlapping Experiment Infrastructure:More, Better, Faster Experimentation](http://storage.googleapis.com/pub-tools-public-publication-data/pdf/36500.pdf)
- [重叠实验框架：更多，更好，更快地实验](http://ju.outofmemory.cn/entry/112729)

## 数据库存储和API

- 离线阶段产生的数据，供在线阶段做实时和准实时的更新
    - 特征，如用户画像，物品画像，更新不频繁
        - 稀疏特征：文本类特征，用户标签
        - 稠密特征：隐因子模型的参数，Embedding向量，采用文件存储，内存映射
        - 正排：以用户ID或物品ID做主键查询
            - 拼凑出样本的特征向量，送入融合算法
            - 用列式数据库存储，如HBase或Cassandra
        - 倒排：以特征做主键查询
            - 召回时，根据特征召回特定的物品
            - 用KV数据库存储，如Redis或Memcached
    - 模型，更新频繁
        - 机器学习模型，采用PMML文件作为模型的存储方式，定义了模型的参数和预测函数
        - 非机器学习模型，如相似度矩阵
    - 结果，离线阶段批量计算的推荐结果
        - 采用KV数据库存储，如Redis
- API
    - TOP K推荐
    - 相关推荐
    - 热门排行榜

# 效果保证

## 推荐系统的测试方法和常用指标

- 测试方法：
    - 业务规则扫描：传统软件的功能测试
    - 离线模拟测试：先收集业务数据，构造用户访问推荐接口的参数
    - 在线对比测试：ABTest
    - 用户访谈
- 常用指标
    - 系统有多好？
        - 评分准确度：RMSE
        - 排序能力：AUC
        - 分类准确率（行为预测）：Top K准确率，Top K召回率
        - 商业指标：点击率，转化率，社交关系数量，用户停留时长，GMV（成交金额）
        - 覆盖率：UV覆盖率，PV覆盖率
        - 失效率：UV失效率，PV失效率
        - 新颖性
        - 更新率
    - 还能好多久？
        - 个性化
        - 基尼系数
        - 多样性

## 推荐系统的攻防

- 基于用户的协同过滤攻击容易生效
    - 目标物品，攻击方要扶持或者打压的物品
    - 助攻物品，用来构造假的相似用户所需要的物品
    - 陪跑物品，用来掩饰造假的物品
- 防护
    - 平台级：提高批量注册用户成本，教育用户积极参与提供真实反馈
    - 数据级：通过聚类方式识别假用户群体
    - 算法级：改进推荐算法，如引入用户质量（限制低质量或新用户参与计算），限制用户的投票权重